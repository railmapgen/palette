import{j as e,_ as b,O as $,a0 as re,f as x,r as M,s as F,a2 as R,e as v,t as O,$ as z,v as ce,a3 as le,w as de,a4 as ue,a5 as Y,M as W,a6 as Z,p as Q,q as X,F as q}from"./chakra-uWiumq66.js";import{l as g,r as p,o as he}from"./react-CVMQYbqF.js";import{b as w,u as f,L as me,i as pe,j as xe,k as je,l as B,m as J,n as ge,o as fe,p as Ce,q as ye,t as Se,v as ke,w as ve,x as be,y as we,z as Le,A as Ee,B as Re,C as Ne,D as Me,F as Oe,G as Pe,H as Te,I as De,J as Ie,K as Ue,N as U,O as Ae,P as A,Q as Fe,S as k,r as C,T as N,U as ee,g as ze,h as Be,E as Je}from"./index-xfkg7BKV.js";import{R as G,M as Ge,a as se,b as _e,c as He,d as Ve}from"./pantone-input-SpKFsG0C.js";import{u as _,M as te,L as qe}from"./line-detail-card-ot6j460s.js";import{P as Ke}from"./pantone-checker-t35BrIgs.js";function $e(){const{t:o,i18n:i}=g(),t=_(),n=w(),{countryList:d}=f(s=>s.app),{country:c,newCountry:l,countryName:r,newCountryLang:h}=f(s=>s.ticket),u={...d.map(s=>[s.id,t(s.name)]).sort((s,a)=>s[1].localeCompare(a[1],i.languages[0])).reduce((s,a)=>a[0]==="UN"?s:{...s,[a[0]]:a[1]},{"":o("Please select...")}),new:o("Add a country/region...")},m=Object.entries(me).reduce((s,a)=>({...s,[a[0]]:t(a[1])}),{}),j=[{type:"select",label:o("Country/Region"),value:c,options:u,disabledOptions:[""],onChange:s=>n(pe(s))},{type:"input",label:o("Country/region code"),placeholder:"e.g. CN, HK, JP (ISO 3166-1 alpha-2)",value:l,validator:s=>s!==""&&!!s.match(/^[A-Z]{2}$|^GB[A-Z]{3}$/),onChange:s=>n(xe(s)),hidden:c!=="new"},{type:"select",label:o("Official language"),value:h,options:m,onChange:s=>n(je(s||void 0)),hidden:c!=="new"}];return e.jsxs(B,{children:[e.jsx(J,{children:e.jsx(b,{as:"h5",size:"sm",children:o("Country/Region")})}),e.jsxs($.div,{px:1,children:[e.jsx(G,{fields:j}),c==="new"&&e.jsx(te,{entries:r,onUpdate:(s,a)=>n(ge({lang:s,name:a})),onLangSwitch:(s,a)=>n(fe({prevLang:s,nextLang:a})),onRemove:s=>n(Ce(s))})]})]})}function Ye(){const{t:o,i18n:i}=g(),t=w(),n=_(),{cityList:d}=f(s=>s.app),{country:c,city:l,newCity:r,cityName:h}=f(s=>s.ticket),u={...d.filter(s=>s.country===c).map(s=>[s.id,n(s.name)]).sort((s,a)=>s[1].localeCompare(a[1],i.languages[0])).reduce((s,a)=>({...s,[a[0]]:a[1]}),{"":o("Please select...")}),new:o("Add a city")+"..."},m=async s=>{if(s==="new"){t(be("new"));return}const a=await we(s,d);t(a?Le(a):Ee())},j=[{type:"select",label:o("City"),value:l,options:u,disabledOptions:[""],onChange:s=>m(s)},{type:"input",label:o("City code"),placeholder:"e.g. hongkong, guangzhou, shanghai",value:r,onChange:s=>t(ye(s)),validator:s=>s!==""&&!s.match(/[^a-z]/),hidden:l!=="new"}];return e.jsxs(B,{children:[e.jsx(J,{children:e.jsx(b,{as:"h5",size:"sm",children:o("City")})}),e.jsxs($.div,{px:1,children:[e.jsx(G,{fields:j}),l==="new"&&e.jsx(te,{entries:h,onUpdate:(s,a)=>t(Se({lang:s,name:a})),onLangSwitch:(s,a)=>t(ke({prevLang:s,nextLang:a})),onRemove:s=>t(ve(s))})]})]})}function We(){const{t:o}=g(),i=w(),t=f(n=>n.ticket.lines);return e.jsxs(B,{children:[e.jsxs(J,{children:[e.jsx(b,{as:"h5",size:"sm",mr:"auto",children:o("Lines")}),e.jsx(Ke,{})]}),e.jsxs(re,{spacing:1,px:1,children:[Object.entries(t).map(([n,d])=>e.jsx(qe,{lineDetail:d,editable:!0,onUpdate:c=>i(Re({entryId:n,updates:c})),onMoveUp:()=>i(Ne(n)),onMoveDown:()=>i(Me(n)),onCopy:()=>i(Oe(n)),onRemove:()=>i(Pe(n)),onNameUpdate:(c,l)=>i(Te({entryId:n,lang:c,name:l})),onLangSwitch:(c,l)=>i(De({entryId:n,prevLang:c,nextLang:l})),onNameRemove:c=>i(Ie({entryId:n,lang:c}))},n)),e.jsx(x,{size:"xs",variant:"ghost",leftIcon:e.jsx(Ge,{}),ml:"auto !important",onClick:()=>i(Ue()),children:o("Add a line")})]})]})}function Ze(o){const{countryErrors:i,cityErrors:t,lineErrors:n,onIgnore:d,onClose:c}=o,{t:l}=g(),r=_();return e.jsxs(e.Fragment,{children:[e.jsxs(M,{children:[e.jsx(F,{children:l("Your inputs contain the following errors. Please consider fixing it before submitting.")}),i.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(b,{as:"h5",size:"sm",my:2,children:l("Country/Region")}),e.jsx(R,{"aria-label":"List of country errors",children:i.map((h,u)=>e.jsx(v,{children:r(U[h])},u))})]}),t.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(b,{as:"h5",size:"sm",my:2,children:l("City")}),e.jsx(R,{"aria-label":"List of city errors",children:t.map((h,u)=>e.jsx(v,{children:r(U[h])},u))})]}),Object.values(n).flat().length>0&&e.jsxs(e.Fragment,{children:[e.jsx(b,{as:"h5",size:"sm",my:2,children:l("Lines")}),e.jsx(R,{"aria-label":"List of line errors",children:Object.entries(n).map(([h,u])=>e.jsxs(v,{children:[h,e.jsx(R,{children:u.map((m,j)=>e.jsx(v,{children:r(U[m])},j))})]},h))})]})]}),e.jsx(O,{children:e.jsxs(z,{children:[e.jsx(x,{onClick:d,children:l("Submit anyway")}),e.jsx(x,{colorScheme:"primary",onClick:c,children:l("Go back")})]})})]})}const K=o=>{var i;return!!((i=o.match(/^https?:\/\//))!=null&&i[0])};function Qe(o){const{refLink:i,onRefLinkChange:t,justification:n,onJustificationChange:d,onPrev:c,onNext:l}=o,{t:r}=g(),h=[{type:"input",value:i,label:r("Reference link"),placeholder:r("Enter a valid URL, e.g.")+" https://en.wikipedia.org",onChange:t,validator:K},{type:"textarea",value:n,label:r("Justification"),placeholder:r("Briefly describe your changes and provide justification"),onChange:d}],u=!i||!n||!K(i);return e.jsxs(e.Fragment,{children:[e.jsxs(M,{children:[e.jsx(F,{children:r("Please provide suitable source and justification.")}),e.jsx(G,{fields:h,minW:"full"})]}),e.jsxs(O,{children:[c&&e.jsx(x,{variant:"ghost",onClick:c,mr:"auto",leftIcon:e.jsx(se,{}),children:r("Previous")}),e.jsx(x,{colorScheme:"primary",onClick:l,rightIcon:e.jsx(_e,{}),isDisabled:u,children:r("Next")})]})]})}function Xe(o){var L,y;const{countryEntry:i,cityEntry:t,paletteList:n,refLink:d,justification:c,onPrev:l}=o,{t:r}=g(),h=ce("primary.500","primary.300"),u=p.useRef(null),m=["**Reference link:** ".concat(d||"(REPLACE ME)"),"**Justification:** ".concat(c||"(REPLACE ME)"),Ae,A("country",i),A("city",t),A("lines",n)].join("\n\n"),j=new URLSearchParams({template:"new-palettes-request.md",labels:"resources",title:"Resources: New palettes of "+((L=t==null?void 0:t.name)==null?void 0:L.en),body:m}),s=new URLSearchParams({template:"new-palettes-request.md",labels:"resources",title:"Resources: New palettes of "+((y=t==null?void 0:t.name)==null?void 0:y.en)}),a=async()=>{u!=null&&u.current&&(u.current.select(),await navigator.clipboard.writeText(m))};return e.jsxs(e.Fragment,{children:[e.jsxs(M,{children:[e.jsx(F,{children:r("If the button below doesn't work for you, please follow the instructions below:")}),e.jsxs(le,{children:[e.jsxs(v,{children:[r("Open")," ",e.jsxs(de,{color:h,href:"https://github.com/railmapgen/rmg-palette/issues/new?"+s.toString(),isExternal:!0,children:["Issue: New Palettes Request ",e.jsx(ue,{as:He})]})]}),e.jsxs(v,{children:[r("Paste following text to the issue body")," ",e.jsx(x,{size:"xs",leftIcon:e.jsx(Ve,{}),onClick:a,children:r("Copy")}),e.jsx(Fe,{ref:u,isReadOnly:!0,defaultValue:m,onClick:({target:P})=>P.select()})]})]})]}),e.jsxs(O,{children:[e.jsx(x,{variant:"ghost",onClick:l,mr:"auto",leftIcon:e.jsx(se,{}),children:r("Previous")}),e.jsx(x,{colorScheme:"primary",onClick:()=>window.open("https://github.com/railmapgen/rmg-palette/issues/new?"+j.toString(),"_blank"),children:r("1-click open issue")})]})]})}function es(o){const{isOpen:i,onClose:t}=o,{t:n}=g(),[d,c]=p.useState([]),[l,r]=p.useState([]),[h,u]=p.useState({}),[m,j]=p.useState(""),[s,a]=p.useState(""),[L,y]=p.useState(!1),[P,T]=p.useState(!1),{countryList:H}=f(I=>I.app),S=f(I=>I.ticket),ne=k.getCountryEntry(S),ae=k.getCityEntry(S),ie=k.getPalettes(S);p.useEffect(()=>{i?(c(k.getCountryErrors(S)),r(k.getCityErrors(S,H)),u(k.getLineErrors(S,H))):(y(!1),j(""),a(""),T(!1))},[i]);const V=d.length>0||l.length>0||Object.values(h).flat().length>0,E=V&&!L,D=!E&&!P,oe=()=>{!E&&!D&&C.storage.remove(N),t()};return e.jsxs(Y,{blockScrollOnMount:!1,isOpen:i,onClose:t,scrollBehavior:"inside",children:[e.jsx(W,{}),e.jsxs(Z,{children:[e.jsx(Q,{children:n("Submit palettes")}),e.jsx(X,{onClick:oe}),E&&e.jsx(Ze,{countryErrors:d,cityErrors:l,lineErrors:h,onIgnore:()=>y(!0),onClose:t}),D&&e.jsx(Qe,{refLink:m,onRefLinkChange:j,justification:s,onJustificationChange:a,onPrev:V?()=>y(!1):void 0,onNext:()=>T(!0)}),!E&&!D&&e.jsx(Xe,{countryEntry:ne,cityEntry:ae,paletteList:ie,refLink:m,justification:s,onPrev:()=>T(!1)})]})]})}function ss(o){const{isOpen:i,onClose:t,incomingState:n}=o,{t:d}=g(),c=w(),l=()=>{C.storage.remove(N),t()},r=()=>{n&&c(ee(n)),t()};return e.jsxs(Y,{isOpen:i,onClose:t,children:[e.jsx(W,{}),e.jsxs(Z,{children:[e.jsx(Q,{children:d("Unsaved draft")}),e.jsx(X,{}),e.jsx(M,{children:d("Do you want to continue with your last unsaved ticket?")}),e.jsx(O,{children:e.jsxs(z,{children:[e.jsx(x,{onClick:l,children:d("Discard")}),e.jsx(x,{colorScheme:"primary",onClick:r,children:d("Continue")})]})})]})]})}function cs(){const{t:o}=g(),i=w(),t=he(),{isDataLoading:n}=f(s=>s.app),[d,c]=p.useState(),[l,r]=p.useState(!1),[h,u]=p.useState(!1);p.useEffect(()=>{const s=C.storage.get(N);if(s)try{const a=JSON.parse(s);Object.keys(a.lines).length>0&&Object.values(a.lines)[0].id&&(c(a),r(!0))}catch(a){console.error("TicketView:: unable to restore draft ticket",s)}},[]);const m=()=>{C.isStandaloneWindow()?t("/"):C.openApp("rmg-palette")},j=()=>{i(ee()),C.storage.remove(N),C.event(Je.RESET_TICKET,{})};return e.jsxs(ze,{alignSelf:"center",sx:{width:{base:"100%",md:520}},children:[n&&e.jsx(Be,{isIndeterminate:!0}),e.jsxs(q,{direction:"column",flex:1,overflowY:"auto",bg:"inherit",children:[e.jsx($e,{}),e.jsx(Ye,{}),e.jsx(We,{})]}),e.jsxs(q,{my:2,children:[e.jsx(x,{size:"sm",onClick:m,children:o("Go back")}),e.jsxs(z,{ml:"auto",children:[e.jsx(x,{size:"sm",variant:"outline",onClick:j,children:o("Reset")}),e.jsx(x,{size:"sm",colorScheme:"primary",onClick:()=>u(!0),children:o("Submit")})]})]}),e.jsx(ss,{isOpen:l,onClose:()=>r(!1),incomingState:d}),e.jsx(es,{isOpen:h,onClose:()=>u(!1)})]})}export{cs as default};
